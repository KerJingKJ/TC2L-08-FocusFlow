<!-- mood_history.html -->

{% extends 'homepage/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'mood/mood_history.css' %}" type="text/css" rel="stylesheet" />

<!-- Keep the "Your mood distribution" heading -->
<h1>Your mood distribution:</h1>

<!-- Removed the emoji and number list -->

<div>
  <canvas id="moodChart" width="max-content" height="80%"></canvas>
</div>

<!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Get the data passed from the Django view
  const moodDates = {{ mood_dates|safe }};  // List of dates for the x-axis
  const moodLevels = {{ mood_levels|safe }};  // List of mood levels for the y-axis

  // Helper function to parse date strings into Date objects
  function parseDate(dateString) {
    return new Date(dateString);
  }

  // Calculate the difference in weeks between two dates
  function getWeekDifference(startDate, endDate) {
    const oneWeekInMillis = 7 * 24 * 60 * 60 * 1000; // Milliseconds in a week
    return Math.floor((endDate - startDate) / oneWeekInMillis) + 1; // Week number starting from 1
  }

  // Group mood entries by relative week and calculate average mood for each week
  const weekMoods = {};  // Store moods grouped by relative week number
  const weekLabels = [];
  const weeksData = [];

  // Get the date of the first mood entry to use as the reference point (Week 1)
  const firstMoodDate = parseDate(moodDates[0]);

  moodDates.forEach((date, index) => {
    const currentMoodDate = parseDate(date);
    const weekNumber = getWeekDifference(firstMoodDate, currentMoodDate);

    if (!weekMoods[weekNumber]) {
      weekMoods[weekNumber] = [];  // Initialize the week if not present
    }
    weekMoods[weekNumber].push(moodLevels[index]);  // Add the mood level to the corresponding week
  });

  // Calculate the average mood for each week
  Object.keys(weekMoods).forEach(week => {
    const moods = weekMoods[week];
    const sum = moods.reduce((a, b) => a + b, 0);
    const averageMood = sum / moods.length;
    weekLabels.push(`Week ${week}`);  // Label for each week (e.g., "Week 1", "Week 2")
    weeksData.push(averageMood);  // Store the average mood for that week
  });

  // Get the context of the canvas where the chart will be rendered
  const ctx = document.getElementById('moodChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 400); // Change the height as needed
  gradient.addColorStop(0, 'cornflowerblue');  // Start color
  gradient.addColorStop(1, 'plum');  // End color

  // Create the chart using Chart.js
  const moodChart = new Chart(ctx, {
    type: 'line',  // Chart type can be 'bar', 'line', etc.
    data: {
      labels: weekLabels,  // Weeks on the x-axis (relative weeks)
      datasets: [{
        label: 'Average Mood per Week',
        data: weeksData,  // Weekly average mood levels on the y-axis
        backgroundColor: 'rgba(0,0,0,0)',  
        borderWidth: 2,
        borderColor: gradient,
        fill: true
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          min: 0,  // Set the minimum value of the y-axis
          max: 4,  // Set the max mood level
          ticks: {
            stepSize: 1,  // Step between mood levels
            callback: function(value) {
              // Convert numerical mood levels to emojis for display
              const moodLabels = {
                0: 'üò°',
                1: 'üò†',
                2: 'üò¢',
                3: 'üòê',
                4: 'üòä'
              };
              return moodLabels[value] || value;
            }
          }
        }
      }
    }
  });
</script>

<h1>Mood History</h1>
<ul>
  {% for mood in moods %}
    <li>
      <p class="logged-on">Logged on: {{ mood.date }}</p>
      <p class="mood">Mood: {{ mood.mood }}</p>
    </li>
  {% empty %}
    <p class="no-moods">No moods logged yet.</p>
  {% endfor %}
</ul>

{% endblock %}
